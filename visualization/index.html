<!DOCTYPE html>
<html>
	<head>
		<title>Prism</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.5.2/cytoscape.min.js"></script>
		<script src="http://marvl.infotech.monash.edu/webcola/cola.v3.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/cytoscape-cola@2.3.0/cytoscape-cola.min.js"></script>
	</head>
	<body>
		<div id="cy" style="width: 100%; height: 100%; position: absolute; top: 0px; left: 0px;"></div>
	</body>
	<script>
		function loadJSON(path, success, error)
{
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function()
	{
		if (xhr.readyState === XMLHttpRequest.DONE) {
			if (xhr.status === 200) {
				if (success)
					success(JSON.parse(xhr.responseText));
			} else {
				if (error)
					error(xhr);
			}
		}
	};
	xhr.open("GET", path, true);
	xhr.send();
}

var cy = cytoscape({
	container: document.getElementById('cy'), // container to render in,
	style: [ // the stylesheet for the graph
		{
			selector: 'node',
			style: {
				'shape': 'rectangle',
				'width': 'label',
				'height': 'label',
				'text-halign': 'center',
				'text-valign': 'center',
				'background-color': '#AAA',
				'label': 'data(disp)'
			}
		},

		{
			selector: 'edge',
			style: {
				'width': 3,
				'line-color': '#ccc',
				'target-arrow-color': '#ccc',
				'target-arrow-shape': 'triangle'
			}
		}
	],
});

function handle_error(xhr) {
	console.log(xhr);
}

function handle_data(data) {
	// add voter nodes
	for (hash in data['voter_nodes']) {
		v = data['voter_nodes'][hash];
		short_hash = hash.substring(58, 64);
		new_node = {
			group: "nodes",
			data: {
				id: hash,
				disp: short_hash,
				// proposer is 0, voter starts from 1
				chain: v['chain'] + 1,
				level: v['level'],
				type: 'voter'
			}
		};
		cy.add(new_node);
	}

	// add proposer nodes
	for (hash in data['proposer_nodes']) {
		v = data['proposer_nodes'][hash];
		short_hash = hash.substring(58, 64);
		new_node = {
			group: "nodes",
			data: {
				id: hash,
				disp: short_hash,
				// proposer is 0, voter starts from 1
				chain: 0,
				level: v['level'],
				type: 'proposer'
			}
		};
		cy.add(new_node);
	}

	// add edges from block to its immediate parent
	for (idx in data['edges']) {
		e = data['edges'][idx];
		if (e['edgetype'] == 'VoterToVoterParent' ||
		    e['edgetype'] == 'ProposerToProposerParent') {
			new_edge = {
				data: {
					source: e['from'],
					target: e['to']
				}
			};
			try {
				cy.add(new_edge);
			}
			catch {
			}
		}
	}

	// run the layout with only edges between blocks and immediate parents
	// or there will be too many edges for cola to determine the tree structure
	cy.layout({
		name: 'cola',
		animate: false,
		flow: {
			axis: 'x'
		},
		avoidOverlap: true,
		convergenceThreshold: 0.1,
		randomize: false,
		/*
		alignment: function(node) {
			return {
				y: (node.data('level') + 1) * 100,
			}
		}*/
	}).run();
}

loadJSON("http://localhost:8080", handle_data, handle_error)
	</script>
</html>
